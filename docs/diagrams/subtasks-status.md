# Subtasks Status: Are They Being Used?

## TL;DR

**Subtasks are GENERATED but NOT STORED** ❌

The code generates subtasks and acceptance criteria, but they are:
1. ✅ Generated by AI parser
2. ✅ Passed to task builder
3. ❌ NOT stored in Task model (Task model has no subtasks field)
4. ⚠️ Sent to Planka using `getattr()` which returns empty list
5. ❌ Never actually appear in Planka

---

## The Evidence

### 1. Subtasks ARE Generated

**Location:** `src/ai/advanced/prd/advanced_parser.py:1077`

```python
# Generate subtasks to break down the work
subtasks = self._generate_subtasks(task_type, project_context, name)

return {
    "name": name,
    "description": description,
    "estimated_hours": estimated_hours,
    "labels": labels,
    "due_date": None,
    "acceptance_criteria": acceptance_criteria,  # ✅ Generated
    "subtasks": subtasks,                        # ✅ Generated
}
```

**Function:** `_generate_subtasks()` at line 1953

Creates task-specific subtasks like:
- For design: "Research existing solutions", "Create wireframes", etc.
- For implementation: "Set up authentication middleware", "Implement registration endpoint", etc.
- For testing: "Write unit test specifications", "Create integration test suite", etc.

### 2. Subtasks Are NOT Stored in Task Model

**Location:** `src/core/models.py:81-145`

```python
@dataclass
class Task:
    """Task model."""
    id: str
    name: str
    description: str
    status: TaskStatus
    priority: Priority
    # ... other fields ...
    labels: List[str] = field(default_factory=list)

    # ❌ NO subtasks field
    # ❌ NO acceptance_criteria field
```

**The Task model has NO fields for:**
- `subtasks`
- `acceptance_criteria`

### 3. Code Comments Acknowledge This

**Location:** `src/ai/advanced/prd/advanced_parser.py:642-652`

```python
# Note: acceptance_criteria and subtasks would need to be added
# to Task model. For now, we store them in labels or use a
# different approach
if enhanced_details.get("acceptance_criteria"):
    # task.acceptance_criteria =
    # enhanced_details["acceptance_criteria"]  # type: ignore
    pass  # ❌ Does nothing

if enhanced_details.get("subtasks"):
    # task.subtasks = enhanced_details["subtasks"]  # type: ignore
    pass  # ❌ Does nothing
```

**This is commented out placeholder code!**

### 4. Task Builder Tries to Include Them (But Fails)

**Location:** `src/integrations/nlp_task_utils.py:186-189`

```python
return {
    "name": task.name,
    "description": task.description,
    # ...
    # Include acceptance criteria if available
    "acceptance_criteria": getattr(task, "acceptance_criteria", []),  # Returns []
    # Include subtasks if available
    "subtasks": getattr(task, "subtasks", []),  # Returns []
}
```

**What happens:**
- `getattr(task, "subtasks", [])` looks for `task.subtasks`
- Task has NO `subtasks` attribute
- Returns default: `[]` (empty list)
- Empty list gets sent to Planka
- Nothing appears on the card

---

## What SHOULD Happen vs What DOES Happen

### What SHOULD Happen

```python
# Step 1: Generate subtasks
subtasks = ["Set up auth middleware", "Implement registration", "Create login flow"]

# Step 2: Store in Task
task = Task(
    name="Implement User Authentication",
    subtasks=subtasks,  # ✅ Store them
    # ...
)

# Step 3: Send to Planka
task_data = {
    "name": task.name,
    "subtasks": task.subtasks,  # ✅ Include in Planka
}

# Step 4: Appear in Planka
# Card shows checkboxes:
# □ Set up auth middleware
# □ Implement registration
# □ Create login flow
```

### What DOES Happen

```python
# Step 1: Generate subtasks
subtasks = ["Set up auth middleware", "Implement registration", "Create login flow"]

# Step 2: Try to store in Task (FAILS - no field)
task = Task(
    name="Implement User Authentication",
    # ❌ NO subtasks parameter - Task model doesn't have it
)
# Subtasks are LOST here!

# Step 3: Try to send to Planka
task_data = {
    "name": task.name,
    "subtasks": getattr(task, "subtasks", []),  # Returns []
}

# Step 4: Nothing appears in Planka
# Card shows:
# (no subtasks)
```

---

## The Fix

### Option 1: Add Fields to Task Model (Recommended)

**File:** `src/core/models.py:81-145`

```python
@dataclass
class Task:
    """Task model."""
    id: str
    name: str
    description: str
    # ... existing fields ...
    labels: List[str] = field(default_factory=list)

    # ✅ ADD THESE:
    subtasks: List[str] = field(default_factory=list)
    acceptance_criteria: List[str] = field(default_factory=list)

    # Existing fields continue...
    source_type: Optional[str] = None
    source_context: Optional[Dict[str, Any]] = None
```

**Then uncomment in advanced_parser.py:645-652:**

```python
if enhanced_details.get("acceptance_criteria"):
    task.acceptance_criteria = enhanced_details["acceptance_criteria"]  # ✅ Works now

if enhanced_details.get("subtasks"):
    task.subtasks = enhanced_details["subtasks"]  # ✅ Works now
```

### Option 2: Store in Description (Interim Solution)

Add subtasks to the task description:

```python
description = relevant_req["description"]

# Add subtasks as checklist in description
if subtasks:
    description += "\n\n**Subtasks:**\n"
    for subtask in subtasks:
        description += f"- [ ] {subtask}\n"
```

**Result in Planka:**
```
Description: Users must be able to register, log in, and log out.

Subtasks:
- [ ] Set up authentication middleware
- [ ] Implement user registration endpoint
- [ ] Create login/logout functionality
- [ ] Add password reset flow
- [ ] Implement JWT token management
```

### Option 3: Use Planka Checklists (Best UX)

If Planka supports native checklists, use their API:

```python
# After creating task
if subtasks:
    await planka_client.add_checklist(
        card_id=task.id,
        name="Implementation Steps",
        items=subtasks
    )
```

---

## Testing Current State

```bash
python -c "
import asyncio
from src.ai.advanced.prd.advanced_parser import AdvancedPRDParser, ProjectConstraints

async def test():
    parser = AdvancedPRDParser()
    constraints = ProjectConstraints(team_size=1, deployment_target='local')

    result = await parser.parse_prd_to_tasks('Build todo app with auth', constraints)

    task = result.tasks[1]  # Implementation task
    print(f'Task: {task.name}')
    print(f'Has subtasks attr: {hasattr(task, \"subtasks\")}')
    print(f'Subtasks value: {getattr(task, \"subtasks\", \"NOT FOUND\")}')

asyncio.run(test())
"
```

**Output:**
```
Task: Implement User Authentication
Has subtasks attr: False
Subtasks value: NOT FOUND
```

---

## Impact

### Current Situation

**Users see in Planka:**
```
Task: Implement User Authentication

Description: Users must be able to register, log in, and log out of
the application using JWT tokens.

(no subtasks, no checklist)
```

**Agent receives:**
- Task description
- Agent instructions (which do have steps)
- But NO checklist in Planka to track progress

### With Fix

**Users see in Planka:**
```
Task: Implement User Authentication

Description: Users must be able to register, log in, and log out of
the application using JWT tokens.

Subtasks:
□ Set up authentication middleware
□ Implement user registration endpoint
□ Create login/logout functionality
□ Add password reset flow
□ Implement JWT token management
□ Add session management
□ Create user profile endpoints
```

**Benefits:**
- ✅ Clear breakdown of work
- ✅ Progress tracking (check off items)
- ✅ Better estimates (see all steps)
- ✅ Easier to review (see what's included)

---

## Recommendation

**Add subtasks and acceptance_criteria to the implementation plan!**

This is separate from the AI-first descriptions issue but should be included because:

1. The code ALREADY generates them
2. They're valuable for users
3. Just need to add 2 fields to Task model
4. Low effort, high value

### Combined Fix

**In AI-first descriptions implementation:**

1. **Phase 1:** Clean up task descriptions (main goal)
   - Use AI content directly
   - Remove template noise

2. **Phase 1.5:** Enable subtasks (bonus)
   - Add fields to Task model
   - Uncomment storage code
   - Test subtasks appear in Planka

3. **Phase 2:** Enhanced instructions (as planned)
   - Instructions reference subtasks
   - Agent can check them off as they work

**Result:**
- Clean AI descriptions ✅
- Subtasks visible in Planka ✅
- Progress tracking ✅
- Better user experience ✅

---

## Questions

1. **Does Planka support checklists?**
   - Need to check Planka API documentation
   - If yes, use native checklist feature
   - If no, add to description as markdown checklist

2. **Should subtasks be in description or separate field?**
   - Separate field: Better for API, progress tracking
   - In description: Simpler, works immediately
   - Recommendation: Separate field if Planka supports it

3. **Should this be part of the AI-first descriptions issue?**
   - It's related (both about task content)
   - Low effort to add
   - High value for users
   - Recommendation: Yes, include as Phase 1.5

---

## Summary

**Current Status:**
- Subtasks generated: ✅
- Subtasks stored: ❌
- Subtasks displayed: ❌

**Root Cause:**
- Task model has no `subtasks` field
- Code comments acknowledge this is TODO

**Fix:**
- Add 2 lines to Task model
- Uncomment 4 lines in advanced_parser.py
- Test with Planka

**Estimated Time:**
- 30 minutes implementation
- 30 minutes testing
- 1 hour total

**Should we add this to the GitHub issue?**
